<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Alumnos | Mi Sistema</title>
  <link rel="stylesheet" href="style.css">
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
</head>
<body>

<!-- Navbar -->
<header class="navbar">
  <div class="logo">Mi Sistema</div>
  <button id="menu-toggle" class="menu-toggle"><i class="fa fa-bars"></i></button>
  <nav class="nav-links" id="nav-links">
    <ul class="menu-horizontal">
      <li><a href="dashboard.html">Dashboard</a></li>
      <li><a href="aulas.html">Aulas</a></li>
      <li><a href="alumnos-dashboard.html">Alumnos</a></li>
      <li><a href="registro-asistencia.html">Registrar Asistencia</a></li>
      <li><a href="historial-asistencia.html">Historial</a></li>
      <li><button id="logout"><i class="fa fa-sign-out-alt"></i> Cerrar sesión</button></li>
    </ul>
  </nav>
</header>

<!-- Contenido principal -->
<main class="main-content">
  <h2>Gestionar Alumnos</h2>

  <!-- Formulario de registro -->
  <div class="alumnos-form-table">
    <div class="alumnos-form">
      <h3>Registrar Alumno</h3>
      <input type="text" id="nombre" placeholder="Nombre alumno">
      <input type="number" id="edad" placeholder="Edad" min="3" max="18">
      <select id="aula">
        <option value="">Seleccionar aula</option>
      </select>
      <button id="guardar">Guardar</button>
    </div>

    <!-- Tabla -->
    <div class="alumnos-table">
      <h3>Lista de alumnos registrados</h3>
      <table id="listaAlumnos">
        <thead>
          <tr>
            <th>Nombre</th>
            <th>Edad</th>
            <th>Aula</th>
            <th>Acciones</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>
  </div>
</main>

<script type="module">
import { db } from "./firebase.js";
import { collection, getDocs, addDoc, doc, updateDoc, deleteDoc } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

// Logout
document.getElementById("logout").onclick = () => {
  localStorage.removeItem("usuario");
  window.location = "index.html";
};

// Verificar login
if(!localStorage.getItem("usuario")) window.location = "index.html";

// Variables del CRUD
const nombre = document.getElementById("nombre");
const edad = document.getElementById("edad");
const aulaSelect = document.getElementById("aula");
const guardarBtn = document.getElementById("guardar");
const listaAlumnos = document.querySelector("#listaAlumnos tbody");

let editId = null;

// Cargar aulas en select
async function cargarAulas() {
  const data = await getDocs(collection(db, "aulas"));
  aulaSelect.innerHTML = '<option value="">Seleccionar aula</option>';
  data.forEach(a => {
    aulaSelect.innerHTML += `<option value="${a.data().nombre}">${a.data().nombre}</option>`;
  });
}

// Guardar alumno
guardarBtn.onclick = async () => {
  if(!nombre.value.trim() || !edad.value || !aulaSelect.value) return alert("Complete todos los campos");

  if(editId) {
    await updateDoc(doc(db, "alumnos", editId), {
      nombre: nombre.value,
      edad: parseInt(edad.value),
      aula: aulaSelect.value
    });
    editId = null;
    guardarBtn.textContent = "Guardar";
  } else {
    await addDoc(collection(db, "alumnos"), {
      nombre: nombre.value,
      edad: parseInt(edad.value),
      aula: aulaSelect.value
    });
  }

  nombre.value = "";
  edad.value = "";
  aulaSelect.value = "";
  cargarAlumnos();
};

// Cargar alumnos
async function cargarAlumnos() {
  listaAlumnos.innerHTML = "";
  const data = await getDocs(collection(db, "alumnos"));
  data.forEach(docu => {
    const tr = document.createElement("tr");
    tr.innerHTML = `
      <td>${docu.data().nombre}</td>
      <td>${docu.data().edad}</td>
      <td>${docu.data().aula}</td>
      <td>
        <button class="editar">Editar</button>
        <button class="eliminar">Eliminar</button>
      </td>
    `;
    tr.querySelector(".editar").onclick = () => {
      nombre.value = docu.data().nombre;
      edad.value = docu.data().edad;
      aulaSelect.value = docu.data().aula;
      editId = docu.id;
      guardarBtn.textContent = "Actualizar";
    };
    tr.querySelector(".eliminar").onclick = async () => {
      if(confirm(`¿Eliminar a ${docu.data().nombre}?`)) {
        await deleteDoc(doc(db, "alumnos", docu.id));
        cargarAlumnos();
      }
    };
    listaAlumnos.appendChild(tr);
  });
}

// Inicial
cargarAulas();
cargarAlumnos();

// Menu móvil
const menuToggle = document.getElementById("menu-toggle");
const navLinks = document.getElementById("nav-links");
menuToggle.onclick = () => navLinks.classList.toggle("active");
</script>

</body>
</html>
